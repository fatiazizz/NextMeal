<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NextMeal — Database ERD</title>
  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({
      startOnLoad: true,
      theme: 'neutral',
      er: {
        diagramPadding: 20,
        layoutDirection: 'TB',
        minEntityWidth: 120,
        minEntityHeight: 80,
        entityPadding: 12,
        stroke: '#333',
        fill: '#f9f9f9',
        fontSize: 12
      }
    });
  </script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      margin: 0;
      padding: 16px;
      background: #e8e8e8;
      min-height: 100vh;
    }
    h1 {
      margin: 0 0 12px 0;
      font-size: 1.25rem;
      color: #333;
    }
    .toolbar {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    .toolbar button {
      padding: 8px 14px;
      font-size: 13px;
      cursor: pointer;
      background: #2c3e50;
      color: #fff;
      border: none;
      border-radius: 6px;
    }
    .toolbar button:hover { background: #34495e; }
    .toolbar a {
      padding: 8px 14px;
      font-size: 13px;
      background: #27ae60;
      color: #fff;
      text-decoration: none;
      border-radius: 6px;
    }
    .toolbar a:hover { background: #2ecc71; }
    #diagram {
      background: #fff;
      border-radius: 8px;
      padding: 24px;
      overflow: auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    #diagram .mermaid {
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }
    #diagram svg {
      max-width: 100%;
      height: auto;
    }
    .hint {
      font-size: 12px;
      color: #666;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <h1>NextMeal — Database ERD (all tables & relations)</h1>
  <div class="toolbar">
    <button type="button" id="btnPng">Download as PNG</button>
    <button type="button" id="btnSvg">Download as SVG</button>
    <a href="https://mermaid.live" target="_blank" rel="noopener">Open in Mermaid Live →</a>
  </div>
  <div id="diagram">
    <pre class="mermaid">
erDiagram
    users ||--o{ recipes : "owns"
    users ||--o{ inventory : "has"
    users ||--o{ notifications : "receives"
    users ||--o{ shopping_list : "has"
    users ||--o{ user_suggestion_preferences : "has"
    users ||--o{ user_ingredient_thresholds : "sets"
    users ||--o{ favorites : "has"

    categories ||--o{ ingredients : "categorizes"
    ingredients ||--o{ recipe_ingredients : "in"
    ingredients ||--o{ inventory : "in"
    ingredients ||--o| notifications : "about"
    ingredients ||--o| shopping_list : "in"
    ingredients ||--o| user_suggestion_preferences : "about"
    ingredients ||--o{ user_ingredient_thresholds : "threshold"
    ingredients ||--|| ingredient_base_unit : "base unit"
    ingredients }o--o{ units : "allowed_units"
    ingredients }o--o{ units : "unit_conversions"

    recipes ||--o{ recipe_ingredients : "contains"
    recipes ||--o| user_suggestion_preferences : "source_ref"
    recipes ||--o{ favorites : "favorited"

    cuisines ||--o{ recipes : "cuisine"
    recipe_categories ||--o{ recipes : "category"
    cooking_methods ||--o{ recipes : "method"

    units ||--o{ inventory : "input_unit, base_unit"
    units ||--o{ recipe_ingredients : "required_unit"
    units ||--o{ ingredient_base_unit : "base_unit"
    units ||--o{ ingredient_allowed_units : "unit_code"
    units ||--o{ ingredient_unit_conversions : "from_unit, to_unit"
    units ||--o{ user_ingredient_thresholds : "threshold_unit"
    units ||--o{ shopping_list : "unit_code"

    inventory ||--o| notifications : "related_inventory"

    users {
        char user_id PK
        string name
        string email
        enum role
        string password
        boolean notifications_enabled
        timestamps
    }

    categories {
        char category_id PK
        string name
        timestamp created_at
    }

    units {
        string unit_code PK
        string unit_kind
        string base_unit
        decimal to_base_factor
    }

    ingredients {
        char ingredient_id PK
        string name
        char category_id FK
        string image_url
        timestamps
    }

    recipes {
        char recipe_id PK
        char owner_user_id FK
        string recipe_name
        text description
        text instructions
        string prep_time
        int servings
        string image_url
        char cuisine_id FK
        char recipe_category_id FK
        char method_id FK
        timestamps
    }

    recipe_ingredients {
        char recipe_ingredient_id PK
        char recipe_id FK
        char ingredient_id FK
        decimal required_quantity
        string required_unit FK
        timestamps
    }

    inventory {
        char inventory_id PK
        char user_id FK
        char ingredient_id FK
        decimal input_quantity
        string input_unit FK
        decimal base_quantity
        string base_unit FK
        string image_url
        decimal minimum_threshold
        date expiration_date
        timestamps
    }

    notifications {
        char notification_id PK
        char user_id FK
        char ingredient_id FK
        char related_inventory_id FK
        string notification_type
        string severity
        string state
        boolean is_read
        json payload
        timestamps
    }

    shopping_list {
        char shopping_list_id PK
        char user_id FK
        char ingredient_id FK
        decimal quantity
        string unit_code FK
        boolean is_checked
        timestamps
    }

    ingredient_base_unit {
        char ingredient_id PK_FK
        string base_unit FK
    }

    ingredient_allowed_units {
        char ingredient_id PK_FK
        string unit_code PK_FK
    }

    ingredient_unit_conversions {
        char ingredient_id PK_FK
        string from_unit PK_FK
        string to_unit PK_FK
        decimal factor
        boolean is_approx
    }

    user_ingredient_thresholds {
        char user_id PK_FK
        char ingredient_id PK_FK
        decimal threshold_quantity
        string threshold_unit FK
        timestamps
    }

    user_suggestion_preferences {
        char preference_id PK
        char user_id FK
        char ingredient_id FK
        string source_type
        char source_ref_recipe_id FK
        string status
        timestamp snooze_until
        timestamps
    }

    favorites {
        char favorite_id PK
        char user_id FK
        char recipe_id FK
        timestamps
    }

    cuisines {
        char cuisine_id PK
        string name
    }

    recipe_categories {
        char recipe_category_id PK
        string name
    }

    cooking_methods {
        char method_id PK
        string name
    }
    </pre>
  </div>
  <p class="hint">Right‑click the diagram → Save image as… or use the buttons above. For a high‑res export, use "Open in Mermaid Live" and export from there.</p>

  <script type="module">
    document.getElementById('btnSvg').addEventListener('click', () => {
      const svg = document.querySelector('#diagram .mermaid svg');
      if (!svg) return;
      const s = new XMLSerializer().serializeToString(svg);
      const blob = new Blob([s], { type: 'image/svg+xml' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'NextMeal-ERD.svg';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    document.getElementById('btnPng').addEventListener('click', () => {
      const svg = document.querySelector('#diagram .mermaid svg');
      if (!svg) return;
      const s = new XMLSerializer().serializeToString(svg);
      const img = new Image();
      const blob = new Blob([s], { type: 'image/svg+xml' });
      const url = URL.createObjectURL(blob);
      img.onload = () => {
        const canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0);
        canvas.toBlob((b) => {
          const a = document.createElement('a');
          a.href = URL.createObjectURL(b);
          a.download = 'NextMeal-ERD.png';
          a.click();
          URL.revokeObjectURL(a.href);
          URL.revokeObjectURL(url);
        }, 'image/png');
      };
      img.src = url;
    });
  </script>
</body>
</html>
